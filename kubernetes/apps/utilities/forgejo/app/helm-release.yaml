# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app forgejo
  namespace: utilities
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 4.3.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      strategy: rollback
  uninstall:
    keepHistory: false
  
  values:
    defaultPodOptions:
      securityContext:
        # Forgejo container needs to run as root initially for s6-overlay
        # It will drop privileges to UID 1000 (git user) after initialization
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
      nodeSelector:
        node-role.kubernetes.io/worker: 'true'
    
    controllers:
      forgejo:
        annotations:
          reloader.stakater.com/auto: "true"
        
        initContainers:
          01-init-db:
            image:
              repository: ghcr.io/onedr0p/postgres-init
              tag: '17.4'
            envFrom:
              - secretRef:
                  name: forgejo
            env:
              INIT_POSTGRES_SUPER_PASS:
                valueFrom:
                  secretKeyRef:
                    name: postgres-superuser
                    key: password
        
        containers:
          app:
            image:
              repository: codeberg.org/forgejo/forgejo
              tag: 10.0.2
            
            env:
              # Basic Configuration
              TZ: ${TIMEZONE}
              FORGEJO__server__DOMAIN: git.${SECRET_DEV_DOMAIN}
              FORGEJO__server__ROOT_URL: https://git.${SECRET_DEV_DOMAIN}
              FORGEJO__server__SSH_DOMAIN: git.${SECRET_DEV_DOMAIN}
              FORGEJO__server__SSH_PORT: 22
              FORGEJO__server__SSH_LISTEN_PORT: 2222
              
              # Database Configuration (PostgreSQL)
              FORGEJO__database__DB_TYPE: postgres
              FORGEJO__database__HOST: defaultpg-rw.databases.svc.cluster.local:5432
              FORGEJO__database__NAME:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: INIT_POSTGRES_DBNAME
              FORGEJO__database__USER:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: INIT_POSTGRES_USER
              FORGEJO__database__PASSWD:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: INIT_POSTGRES_PASS
              
              # Security
              FORGEJO__security__INSTALL_LOCK: "true"
              FORGEJO__security__INTERNAL_TOKEN:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: FORGEJO__security__INTERNAL_TOKEN
              FORGEJO__security__SECRET_KEY:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: FORGEJO__security__SECRET_KEY
              
              # OAuth2/JWT
              FORGEJO__oauth2__JWT_SECRET:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: FORGEJO__oauth2__JWT_SECRET
              
              # Service Configuration
              FORGEJO__service__DISABLE_REGISTRATION: "true"
              FORGEJO__service__REQUIRE_SIGNIN_VIEW: "false"
              FORGEJO__service__REGISTER_EMAIL_CONFIRM: "true"
              FORGEJO__service__ENABLE_NOTIFY_MAIL: "false"
              FORGEJO__service__ALLOW_ONLY_EXTERNAL_REGISTRATION: "true"
              FORGEJO__service__SHOW_REGISTRATION_BUTTON: "false"
              
              # OpenID Connect (Authelia)
              FORGEJO__openid__ENABLE_OPENID_SIGNIN: "true"
              FORGEJO__openid__ENABLE_OPENID_SIGNUP: "true"
              
              # Actions (CI/CD)
              FORGEJO__actions__ENABLED: "true"
              FORGEJO__actions__DEFAULT_ACTIONS_URL: https://code.forgejo.org
              
              # Storage - S3 (MinIO) for LFS, Avatars, Attachments
              FORGEJO__storage__STORAGE_TYPE: minio
              FORGEJO__storage__SERVE_DIRECT: "false"
              FORGEJO__storage__MINIO_ENDPOINT: minio.storage.svc.cluster.local:9000
              FORGEJO__storage__MINIO_BUCKET: ${S3_FORGEJO}
              FORGEJO__storage__MINIO_LOCATION: local
              FORGEJO__storage__MINIO_USE_SSL: "false"
              FORGEJO__storage__MINIO_ACCESS_KEY_ID:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: AWS_ACCESS_KEY_ID
              FORGEJO__storage__MINIO_SECRET_ACCESS_KEY:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: AWS_SECRET_ACCESS_KEY
              
              # LFS (Large File Storage) - inherits from storage settings
              FORGEJO__lfs__STORAGE_TYPE: minio
              FORGEJO__lfs__MINIO_ENDPOINT: minio.storage.svc.cluster.local:9000
              FORGEJO__lfs__MINIO_BUCKET: ${S3_FORGEJO}
              FORGEJO__lfs__MINIO_LOCATION: local
              FORGEJO__lfs__MINIO_USE_SSL: "false"
              FORGEJO__lfs__MINIO_ACCESS_KEY_ID:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: AWS_ACCESS_KEY_ID
              FORGEJO__lfs__MINIO_SECRET_ACCESS_KEY:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: AWS_SECRET_ACCESS_KEY
              
              # Packages/Container Registry - inherits from storage settings
              FORGEJO__packages__ENABLED: "true"
              FORGEJO__packages__STORAGE_TYPE: minio
              FORGEJO__packages__MINIO_ENDPOINT: minio.storage.svc.cluster.local:9000
              FORGEJO__packages__MINIO_BUCKET: ${S3_FORGEJO}
              FORGEJO__packages__MINIO_LOCATION: local
              FORGEJO__packages__MINIO_USE_SSL: "false"
              FORGEJO__packages__MINIO_ACCESS_KEY_ID:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: AWS_ACCESS_KEY_ID
              FORGEJO__packages__MINIO_SECRET_ACCESS_KEY:
                valueFrom:
                  secretKeyRef:
                    name: forgejo
                    key: AWS_SECRET_ACCESS_KEY
              
              # Mailer (optional - can be configured later)
              FORGEJO__mailer__ENABLED: "false"
              
              # Other settings
              FORGEJO__repository__DEFAULT_BRANCH: main
              FORGEJO__repository__DEFAULT_PRIVATE: last
              FORGEJO__ui__DEFAULT_THEME: forgejo-auto
            
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api/healthz
                    port: 3000
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 10
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api/healthz
                    port: 3000
                  initialDelaySeconds: 10
                  periodSeconds: 5
                  timeoutSeconds: 1
                  failureThreshold: 5
              startup:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api/healthz
                    port: 3000
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 2
                  failureThreshold: 60
            
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 2Gi
    
    service:
      app:
        controller: forgejo
        ports:
          http:
            port: 3000
          ssh:
            port: 2222
    
    ingress:
      app:
        className: traefik
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-production
          hajimari.io/enable: 'true'
          hajimari.io/icon: git
          hajimari.io/group: Utilities
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
        hosts:
          - host: &host git.${SECRET_DEV_DOMAIN}
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: http
        tls:
          - hosts:
              - *host
            secretName: *host
    
    persistence:
      data:
        enabled: true
        existingClaim: forgejo-data-volume
        globalMounts:
          - path: /data
      
      config:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /etc/forgejo
      
      temp:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /tmp
