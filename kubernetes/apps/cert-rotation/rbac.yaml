---
# ServiceAccount for cert rotation
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-rotator
  namespace: cert-rotation

---
# ClusterRole for cert rotation
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-rotator
rules:
  # Create CSRs
  - apiGroups: ["certificates.k8s.io"]
    resources: ["certificatesigningrequests"]
    verbs: ["create", "get", "list", "watch"]
  # Approve CSRs
  - apiGroups: ["certificates.k8s.io"]
    resources: ["certificatesigningrequests/approval"]
    verbs: ["update"]
  # Approve signers
  - apiGroups: ["certificates.k8s.io"]
    resources: ["signers"]
    resourceNames: ["kubernetes.io/kube-apiserver-client"]
    verbs: ["approve"]
  # Get cluster info for kubeconfig
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["namespaces", "services"]
    verbs: ["get", "list"]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cert-rotator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cert-rotator
subjects:
  - kind: ServiceAccount
    name: cert-rotator
    namespace: cert-rotation
