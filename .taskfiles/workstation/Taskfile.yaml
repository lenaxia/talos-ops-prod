---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:

  arch:
    desc: Set up Arch Linux tools
    cmd: >
      {{.PKGMGR}} -Syu --needed --noconfirm --noprogressbar
      $(cat {{.ROOT_DIR}}/.taskfiles/workstation/Archfile | xargs)
    vars:
      PKGMGR:
        sh: which paru || which yay
    preconditions:
      - test -f {{.ROOT_DIR}}/.taskfiles/workstation/Archfile
      - which paru || which yay

  brew:
    desc: Set up Homebrew tools
    cmd: brew bundle --file {{.ROOT_DIR}}/.taskfiles/workstation/Brewfile
    sources:
      - '{{.ROOT_DIR}}/.taskfiles/workstation/Brewfile'
    generates:
      - '{{.ROOT_DIR}}/.taskfiles/workstation/Brewfile.lock.json'
    preconditions:
      - test -f {{.ROOT_DIR}}/.taskfiles/workstation/Brewfile
      - which brew

  direnv:
    desc: Set up direnv hooks
    cmd: direnv allow .
    status:
      - '[[ $(direnv status --json | jq ".state.foundRC.allowed") == 0 ]]'
      - '[[ $(direnv status --json | jq ".state.loadedRC.allowed") == 0 ]]'
    preconditions:
      - which direnv

  generic-linux:
    desc: Set up CLI tools into the projects .bin directory
    dir: '{{.ROOT_DIR}}/.bin'
    platforms: ['linux/amd64', 'linux/arm64']
    cmds:
      - for:
          - budimanjojo/talhelper?as=talhelper
          - cloudflare/cloudflared?as=cloudflared
          - FiloSottile/age?as=age
          - fluxcd/flux2?as=flux
          - helmfile/helmfile?as=helmfile
          - jqlang/jq?as=jq
          - kubernetes-sigs/kustomize?as=kustomize
          - mikefarah/yq?as=yq
          - siderolabs/talos?as=talosctl
          - yannh/kubeconform?as=kubeconform
        cmd: curl -fsSL "https://i.jpillora.com/{{.ITEM}}&type=script" | bash
      - cmd: |
          ARCH="amd64"
          FALLBACK_VERSION="v1.30.0"
          
          download_kubectl() {
            local arch=$1
            local fallback=$2
            local url=""
            local max_retries=3
            local retry_count=0
            local timeout=30
            
            while [ $retry_count -lt $max_retries ]; do
              echo "Fetching Kubernetes stable version (attempt $((retry_count + 1))/$max_retries)..."
              if VERSION=$(curl -fsSL --max-time $timeout "https://dl.k8s.io/release/stable.txt" 2>/dev/null); then
                if [ -n "$VERSION" ]; then
                  url="https://dl.k8s.io/release/${VERSION}/bin/linux/${arch}/kubectl"
                  break
                fi
              fi
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "Retrying in 5 seconds..."
                sleep 5
              fi
            done
            
            if [ -z "$url" ] || [ -z "$VERSION" ]; then
              echo "Failed to fetch stable version after $max_retries attempts"
              echo "Using fallback version: $fallback"
              url="https://dl.k8s.io/release/${fallback}/bin/linux/${arch}/kubectl"
            fi
            
            echo "Downloading kubectl from: $url"
            if ! curl -fsSL --max-time 300 --retry 3 "$url" -o kubectl; then
              echo "Failed to download kubectl from $url"
              return 1
            fi
            chmod +x kubectl
            echo "kubectl downloaded successfully"
          }
          
          download_kubectl "$ARCH" "$FALLBACK_VERSION"
          curl -fsSL --max-time 300 --retry 3 -o sops https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.amd64
          chmod +x sops
        platforms: ['linux/amd64']
      - cmd: |
          ARCH="arm64"
          FALLBACK_VERSION="v1.30.0"
          
          download_kubectl() {
            local arch=$1
            local fallback=$2
            local url=""
            local max_retries=3
            local retry_count=0
            local timeout=30
            
            while [ $retry_count -lt $max_retries ]; do
              echo "Fetching Kubernetes stable version (attempt $((retry_count + 1))/$max_retries)..."
              if VERSION=$(curl -fsSL --max-time $timeout "https://dl.k8s.io/release/stable.txt" 2>/dev/null); then
                if [ -n "$VERSION" ]; then
                  url="https://dl.k8s.io/release/${VERSION}/bin/linux/${arch}/kubectl"
                  break
                fi
              fi
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "Retrying in 5 seconds..."
                sleep 5
              fi
            done
            
            if [ -z "$url" ] || [ -z "$VERSION" ]; then
              echo "Failed to fetch stable version after $max_retries attempts"
              echo "Using fallback version: $fallback"
              url="https://dl.k8s.io/release/${fallback}/bin/linux/${arch}/kubectl"
            fi
            
            echo "Downloading kubectl from: $url"
            if ! curl -fsSL --max-time 300 --retry 3 "$url" -o kubectl; then
              echo "Failed to download kubectl from $url"
              return 1
            fi
            chmod +x kubectl
            echo "kubectl downloaded successfully"
          }
          
          download_kubectl "$ARCH" "$FALLBACK_VERSION"
          curl -fsSL --max-time 300 --retry 3 -o sops https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.arm64
          chmod +x sops
        platforms: ['linux/arm64']
      - cmd: curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      - cmd: curl -fsSL https://github.com/mitsuhiko/minijinja/releases/latest/download/minijinja-cli-installer.sh | bash
    env:
      MINIJINJA_CLI_INSTALL_DIR: '.'
      MINIJINJA_CLI_UNMANAGED_INSTALL: 'true'
      HELM_INSTALL_DIR: '.'
      USE_SUDO: 'false'

  venv:
    desc: Set up virtual environment
    cmds:
      - python3 -m venv {{.VIRTUAL_ENV}}
      - '{{.VIRTUAL_ENV}}/bin/python3 -m pip install --upgrade pip setuptools wheel'
      - '{{.VIRTUAL_ENV}}/bin/python3 -m pip install --upgrade --requirement "{{.ROOT_DIR}}/requirements.txt"'
    sources:
      - '{{.ROOT_DIR}}/requirements.txt'
    generates:
      - '{{.VIRTUAL_ENV}}/pyvenv.cfg'
    preconditions:
      - test -f {{.ROOT_DIR}}/requirements.txt
      - which python3
