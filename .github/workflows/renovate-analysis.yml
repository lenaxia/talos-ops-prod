name: Renovate PR Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze (leave empty for all)'
        required: false
        type: string

env:
  OWNER: lenaxia
  REPO: talos-ops-prod

jobs:
  analyze-prs:
    # Only run for Renovate PRs or manual triggers
    if: |
      github.event_name != 'pull_request' || 
      github.event.pull_request.user.login == 'renovate[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Create temp directory
        run: mkdir -p .tmp

      - name: Analyze Renovate PRs
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIGGERING_PR: ${{ github.event.pull_request.number || inputs.pr_number || '' }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # Determine which PRs to analyze
          if [ "$EVENT_NAME" = "pull_request" ]; then
            # Only analyze the triggering PR for pull_request events
            ANALYZE_MODE="single"
            TARGET_PR="$TRIGGERING_PR"
            echo "Mode: Analyzing single PR #$TARGET_PR (triggered by pull_request event)"
          elif [ -n "$TRIGGERING_PR" ]; then
            # Manual trigger with specific PR number
            ANALYZE_MODE="single"
            TARGET_PR="$TRIGGERING_PR"
            echo "Mode: Analyzing single PR #$TARGET_PR (manual workflow_dispatch)"
          else
            # Manual trigger without PR number - analyze all
            ANALYZE_MODE="all"
            TARGET_PR=""
            echo "Mode: Analyzing all open Renovate PRs (manual workflow_dispatch)"
          fi

          # For single PR mode, check if already analyzed
          if [ "$ANALYZE_MODE" = "single" ] && [ -n "$TARGET_PR" ]; then
            echo "Checking if PR #$TARGET_PR was already analyzed..."
            
            # Get PR details
            PR_DATA=$(gh pr view "$TARGET_PR" --json updatedAt)
            PR_UPDATED=$(echo "$PR_DATA" | jq -r '.updatedAt')
            
            echo "PR Last Updated: $PR_UPDATED"
            
            # Get existing comments
            EXISTING_COMMENTS=$(gh pr view "$TARGET_PR" --json comments --jq '.comments[] | select(.author.login == "github-actions" and (.body | startswith("## Renovate PR Analysis")))')
            
            if [ -n "$EXISTING_COMMENTS" ]; then
              echo "Found existing analysis comment(s)"
              
              # Get the most recent comment date
              COMMENT_DATE=$(echo "$EXISTING_COMMENTS" | jq -r '.createdAt' | tail -1)
              
              echo "Most recent comment date: $COMMENT_DATE"
              
              # Compare timestamps - if PR was updated before or at the same time as last comment, skip
              PR_UPDATED_TS=$(date -d "$PR_UPDATED" +%s 2>/dev/null || echo "0")
              COMMENT_DATE_TS=$(date -d "$COMMENT_DATE" +%s 2>/dev/null || echo "0")
              
              # Add 60 second buffer to account for workflow posting comment
              COMMENT_BUFFER_TS=$((COMMENT_DATE_TS + 60))
              
              if [ "$PR_UPDATED_TS" -le "$COMMENT_BUFFER_TS" ]; then
                echo "✓ PR #$TARGET_PR already analyzed and no updates since last comment. Skipping."
                exit 0
              else
                echo "⚠ PR #$TARGET_PR was updated after last analysis. Re-analyzing."
              fi
            else
              echo "No existing analysis found. Proceeding with analysis."
            fi
          fi

          # Create prompt file
          cat > .tmp/renovate-prompt.txt <<PROMPT_EOF
          You are an AI assistant that analyzes Renovatebot pull requests for a Kubernetes cluster repository.

          Your Task:
          Analyze Renovate PRs and provide detailed reports. DO NOT merge any PRs. Only provide analysis reports as PR comments.

          Analysis Mode: ${ANALYZE_MODE}
          $(if [ "$ANALYZE_MODE" = "single" ]; then echo "Target PR Number: $TARGET_PR"; fi)

          Process:

          1. Get PRs to analyze:
             $(if [ "$ANALYZE_MODE" = "single" ]; then
               echo "- Only analyze PR #$TARGET_PR"
               echo "- Verify it is authored by \"renovate[bot]\""
               echo "- If not a Renovate PR, exit gracefully with a message"
             else
               echo "- List all open PRs and filter for Renovate PRs"
               echo "- Check if author is \"renovate[bot]\""
               echo "- For each PR, check for existing analysis comments"
               echo "- Skip PRs that were already analyzed and haven't changed"
             fi)

          2. For each Renovate PR to analyze:

             a. Parse PR title to identify:
                - What dependency is being updated
                - Version range (old version → new version)
                - Update type (patch/minor/major/digest)

             b. Get PR files changed
                - Identify what Helm chart or values are being modified
                - Extract current configuration from files

             c. Identify upstream repository
                - For Helm charts: Check the chart repository URL
                - For Docker images: Extract image name to find source repo
                - For GitHub Actions: Get the action's repository
                - Look in PR body for repository links

             d. Fetch release information from upstream
                - Get the release notes for new version
                - If minor/major update, get release notes between old and new versions
                - Extract changelog, breaking changes, migration guides

             e. Analyze changes
                - What's new in this release?
                - Any breaking changes?
                - Any deprecated features?
                - New configuration options added?
                - Configuration options removed?

             f. Check our Helm release configuration
                - Look at the files changed in the PR
                - Identify what values we're currently using
                - Compare with new release requirements

             h. Determine what changes we need
                - Do we need to update our Helm values?
                - Are we using deprecated options?
                - Do we need to add new required parameters?
                - Are there any configuration compatibility issues?

          3. Create a detailed analysis comment on the PR with this structure:

             \`\`\`markdown
             ## Renovate PR Analysis

             ### Update Summary
             - Dependency: [name]
             - Version: [old] → [new]
             - Type: [patch/minor/major/digest]

             ### Release Changes
             [Summarize what's new in this release, including:]
             - New features
             - Bug fixes
             - Performance improvements
             - Other notable changes

             ### Breaking Changes
             [List any breaking changes from the release notes]
             [If none, state "No breaking changes detected" or "Breaking changes in this version do not affect our usage"]

             ### Configuration Changes Required
             [Detailed analysis of what we need to change in our Helm release:]
             - List new required parameters we need to add
             - List deprecated options we're using that need removal
             - List any values that need updating
             - Provide example configuration if helpful

             ### Migration Notes
             [Any migration steps or considerations from the upstream release]

             ### Recommendation
             Based on analysis:
             - [Safe to merge / Needs manual review / Requires code changes]
             - Brief explanation of why
             \`\`\`

          4. Take action based on analysis:

             **If "Safe to merge":**
             - Use github_merge_pull_request to merge the PR with squash method
             - No configuration changes needed in our repository
             - Only merge if:
               * No breaking changes affecting our usage
               * No new required configuration parameters
               * Only bug fixes, minor improvements, or non-breaking features
             
             **If "Requires code changes":**
             - Create a new branch: config/renovate-pr-[PR_NUMBER]-changes
             - Use github_create_branch to create the branch from main
             - Apply the necessary configuration changes using github_create_or_update_file or github_push_files
             - Create a new PR with:
               * Title: "config: Configuration changes for [dependency] update"
               * Body: Reference the Renovate PR and explain changes needed
               * Link to original Renovate PR: "Required for #[PR_NUMBER]"
             - Add a comment to the original Renovate PR:
               * "⚠️ Configuration changes required before merging"
               * "I've created PR #[NEW_PR] with the necessary configuration updates"
               * "Please review and merge the configuration PR first, then this PR can be merged"
             
             **If "Needs manual review":**
             - Do NOT merge
             - Do NOT create a PR
             - Only post the analysis comment
             - This applies to:
               * Breaking changes that need careful review
               * Major version updates with significant changes
               * Uncertain impact on our specific configuration
               * Excluded dependencies (Authelia, Traefik, MinIO, Bitnami)

          Important Notes:

          - NOTE: Duplicate detection is handled before this prompt, so you can proceed with analysis
          - Exclude PRs related to: Authelia, Traefik, MinIO, Bitnami charts
          - Skip PRs with "abandoned" in the title
          - Always check if breaking changes affect our specific usage
          - Be thorough - fetch actual release notes from upstream repositories
          - Provide actionable, specific recommendations
          - Use GitHub tools to fetch release information

          Special Exclusions:

          1. Bitnami charts - Never use or upgrade (revoked open source charts)
          2. MinIO - Deprecated open source, became open source hostile
          3. Authelia, Traefik - Require manual review per policy

          Variables:
          - OWNER: ${{ env.OWNER }}
          - REPO: ${{ env.REPO }}

          Example Flow:

          For a PR titled "Update helm chart jellyfin from 10.2.0 to 10.3.0":

          1. Parse: jellyfin-helm-chart, 10.2.0 → 10.3.0 (minor update)
          2. Get files changed: kubernetes/apps/media/jellyfin/app/helmrelease.yaml
          3. Identify upstream: https://github.com/jellyfin/jellyfin-helm-chart
          4. Fetch release notes for v10.3.0
          5. Analyze: Check for breaking changes, new config options
          6. Review our current helmrelease.yaml values
          7. Identify: Do we need to update any values?
          8. Create detailed comment on the PR with findings
          9. If safe to merge: Use github_merge_pull_request to merge
          10. If changes needed: Create config PR with required updates

          Now proceed with the analysis based on the mode specified above.
          PROMPT_EOF

          # Run opencode with the prompt
          opencode run -m vllm-local/default "$(cat .tmp/renovate-prompt.txt)"

